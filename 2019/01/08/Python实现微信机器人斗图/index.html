<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet"><link href="/css/main.css?v=5.1.4" rel="stylesheet"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-16x16.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x21.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.4"><link rel="mask-icon" href="/images/favicon-16x16.png?v=5.1.4" color="#222"><meta name="keywords" content="Python,"><meta name="description" content="前情提要以前接了图灵机器人的api做过一个微信小机器人,但是这个机器人只会尬聊也就算了，竟然连斗图都不能！！！虽说图灵机器人官网上有这个api,可是由于我是用python手动接入而不是直接授权，发送表情包给他依然会回复尬聊。我深信没有斗图的机器人是没有灵魂的，于是想动手自己写一个。"><meta name="keywords" content="Python"><meta property="og:type" content="article"><meta property="og:title" content="Python实现微信机器人斗图"><meta property="og:url" content="https://sika0819.top/2019/01/08/Python实现微信机器人斗图/index.html"><meta property="og:site_name" content="Sika的养虫小窝"><meta property="og:description" content="前情提要以前接了图灵机器人的api做过一个微信小机器人,但是这个机器人只会尬聊也就算了，竟然连斗图都不能！！！虽说图灵机器人官网上有这个api,可是由于我是用python手动接入而不是直接授权，发送表情包给他依然会回复尬聊。我深信没有斗图的机器人是没有灵魂的，于是想动手自己写一个。"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://sika0819.top/images/pasted-48.png"><meta property="og:image" content="https://sika0819.top/images/weixin.jpg"><meta property="og:updated_time" content="2019-05-15T07:03:54.731Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Python实现微信机器人斗图"><meta name="twitter:description" content="前情提要以前接了图灵机器人的api做过一个微信小机器人,但是这个机器人只会尬聊也就算了，竟然连斗图都不能！！！虽说图灵机器人官网上有这个api,可是由于我是用python手动接入而不是直接授权，发送表情包给他依然会回复尬聊。我深信没有斗图的机器人是没有灵魂的，于是想动手自己写一个。"><meta name="twitter:image" content="https://sika0819.top/images/pasted-48.png"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://sika0819.top/2019/01/08/Python实现微信机器人斗图/"><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><title>Python实现微信机器人斗图 | Sika的养虫小窝</title></head><script src="/js/src/crash_cheat.js"></script><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Sika的养虫小窝</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://sika0819.top/2019/01/08/Python实现微信机器人斗图/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="赵思佳"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sika的养虫小窝"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Python实现微信机器人斗图</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-08T13:54:00+08:00">2019-01-08</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h1><p>以前接了图灵机器人的api做过一个<a href="https://sika0819.top/2018/09/05/Python%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%B0%8F%E6%9C%BA%E5%99%A8%E4%BA%BA/">微信小机器人</a>,但是这个机器人只会尬聊也就算了，竟然连斗图都不能！！！虽说图灵机器人官网上有这个api,可是由于我是用python手动接入而不是直接授权，发送表情包给他依然会回复尬聊。我深信没有斗图的机器人是没有灵魂的，于是想动手自己写一个。<br><a id="more"></a><br>参考：<a href="https://blog.csdn.net/lmdsq/article/details/78931924" target="_blank" rel="noopener">用python爬取斗图网</a></p><p>打印从用户哪里获得的消息，会发现，接收表情包返回的是一行文本信息：【收到不支持的消息类型，暂无法显示】</p><p>于是我们稍微改一改之前的代码，对这行文本进行判断，只要接收到这行消息，参考爬取代码从斗图网随机爬取一个表情包下载下来，再传入临时素材库，获取mediaid,再生成图片消息发送给用户就可以了。</p><p>效果：因为又要下载又要上传显得稍微有点卡顿，但是还可以。</p><p><img src="/images/pasted-48.png" alt="upload successful"></p><p>核心代码：</p><p>handler.py<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> reply</span><br><span class="line"><span class="keyword">import</span> receive</span><br><span class="line"><span class="keyword">import</span> web</span><br><span class="line"><span class="keyword">import</span> robot</span><br><span class="line"><span class="keyword">import</span> getemoticon</span><br><span class="line"><span class="keyword">from</span> basic <span class="keyword">import</span> Basic</span><br><span class="line"><span class="keyword">from</span> media <span class="keyword">import</span> Media</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span><span class="params">(object)</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			data = web.input()</span><br><span class="line">			<span class="keyword">if</span> len(data) == <span class="number">0</span>:</span><br><span class="line">				<span class="keyword">return</span> <span class="string">"hello, this is handle view"</span></span><br><span class="line">			signature = data.signature</span><br><span class="line">			timestamp = data.timestamp</span><br><span class="line">			nonce = data.nonce</span><br><span class="line">			echostr = data.echostr</span><br><span class="line">			token = <span class="string">"yourtoken"</span></span><br><span class="line">			list = [token, timestamp, nonce]</span><br><span class="line">			list.sort()</span><br><span class="line">			sha1 = hashlib.sha1()</span><br><span class="line">			map(sha1.update, list)</span><br><span class="line">			hashcode = sha1.hexdigest()</span><br><span class="line">			<span class="keyword">if</span> hashcode == signature:</span><br><span class="line">				<span class="keyword">return</span> echostr</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				<span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">		<span class="keyword">except</span> Exception:</span><br><span class="line">			<span class="keyword">return</span> Exception.message</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">POST</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			webData = web.data()</span><br><span class="line">			<span class="comment">#print("Handle Post webdata is ", webData)</span></span><br><span class="line">			recMsg=receive.parse_xml(webData)</span><br><span class="line">			<span class="keyword">if</span> isinstance(recMsg, receive.Msg):</span><br><span class="line">				toUser = recMsg.FromUserName</span><br><span class="line">				fromUser = recMsg.ToUserName</span><br><span class="line">				<span class="keyword">if</span> recMsg.MsgType==<span class="string">'text'</span>:</span><br><span class="line">					content = recMsg.Content</span><br><span class="line">					print(content);</span><br><span class="line">					<span class="keyword">if</span> content==<span class="string">"【收到不支持的消息类型，暂无法显示】"</span>:</span><br><span class="line">						path=getemoticon.getRandomEmoticon()</span><br><span class="line">						print(path)</span><br><span class="line">						myMedia = Media()</span><br><span class="line">						accessToken = Basic().get_access_token()</span><br><span class="line">						mediaType = <span class="string">"image"</span></span><br><span class="line">						callbackjson = myMedia.upload(accessToken, path, mediaType)</span><br><span class="line">						callback = json.loads(callbackjson)</span><br><span class="line">						mediaId=callback[<span class="string">u'media_id'</span>]</span><br><span class="line">						createTime=callback[<span class="string">u'created_at'</span>]</span><br><span class="line">						replyMsg = reply.ImageMsg(toUser, fromUser,createTime,mediaType,mediaId)</span><br><span class="line">						<span class="keyword">return</span> replyMsg.send()</span><br><span class="line">					<span class="keyword">else</span>:</span><br><span class="line">						rpyMsg= robot.get_response(content,fromUser)</span><br><span class="line">						replyMsg=reply.TextMsg(toUser, fromUser,rpyMsg)</span><br><span class="line">						<span class="keyword">return</span> replyMsg.send()</span><br><span class="line">				<span class="keyword">if</span> recMsg.MsgType == <span class="string">'image'</span>:</span><br><span class="line">					mediaId = recMsg.MediaId</span><br><span class="line">					replyMsg = reply.ImageMsg(toUser, fromUser, mediaId)</span><br><span class="line">					<span class="keyword">return</span> replyMsg.send()</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				print(<span class="string">"none handler yet"</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="string">"success"</span></span><br><span class="line">		<span class="keyword">except</span> Exception <span class="keyword">as</span> Argument:</span><br><span class="line">			<span class="keyword">print</span> Exception.message</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"fail"</span></span><br></pre></td></tr></table></figure><p></p><p>media.py<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># filename: media.py</span></span><br><span class="line"><span class="keyword">from</span> basic <span class="keyword">import</span> Basic</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> poster.encode</span><br><span class="line"><span class="keyword">from</span> poster.streaminghttp <span class="keyword">import</span> register_openers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Media</span><span class="params">(object)</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">		register_openers()</span><br><span class="line">	<span class="comment">#上传图片</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(self, accessToken, filePath, mediaType)</span>:</span></span><br><span class="line">		openFile = open(filePath, <span class="string">"rb"</span>)</span><br><span class="line">		param = &#123;<span class="string">'media'</span>: openFile&#125;</span><br><span class="line">		postData, postHeaders = poster.encode.multipart_encode(param)</span><br><span class="line"></span><br><span class="line">		postUrl = <span class="string">"https://api.weixin.qq.com/cgi-bin/media/upload?access_token=%s&amp;type=%s"</span> % (accessToken, mediaType)</span><br><span class="line">		request = urllib2.Request(postUrl, postData, postHeaders)</span><br><span class="line">		urlResp = urllib2.urlopen(request)</span><br><span class="line">		<span class="keyword">return</span> urlResp.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># if __name__ == '__main__':</span></span><br><span class="line">	<span class="comment"># myMedia = Media()</span></span><br><span class="line">	<span class="comment"># accessToken = Basic().get_access_token()</span></span><br><span class="line">	<span class="comment"># filePath = "img/帽冷汗.jpg"   #请安实际填写</span></span><br><span class="line">	<span class="comment"># mediaType = "image"</span></span><br><span class="line">	<span class="comment"># myMedia.upload(accessToken, filePath, mediaType)</span></span><br></pre></td></tr></table></figure><p></p><p>reply.py<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Msg</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextMsg</span><span class="params">(Msg)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, toUserName, fromUserName, content)</span>:</span></span><br><span class="line">        self.__dict = dict()</span><br><span class="line">        self.__dict[<span class="string">'ToUserName'</span>] = toUserName</span><br><span class="line">        self.__dict[<span class="string">'FromUserName'</span>] = fromUserName</span><br><span class="line">        self.__dict[<span class="string">'CreateTime'</span>] = int(time.time())</span><br><span class="line">        self.__dict[<span class="string">'Content'</span>] = content</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self)</span>:</span></span><br><span class="line">        XmlForm = <span class="string">"""</span></span><br><span class="line"><span class="string">        &lt;xml&gt;</span></span><br><span class="line"><span class="string">        &lt;ToUserName&gt;&lt;![CDATA[&#123;ToUserName&#125;]]&gt;&lt;/ToUserName&gt;</span></span><br><span class="line"><span class="string">        &lt;FromUserName&gt;&lt;![CDATA[&#123;FromUserName&#125;]]&gt;&lt;/FromUserName&gt;</span></span><br><span class="line"><span class="string">        &lt;CreateTime&gt;&#123;CreateTime&#125;&lt;/CreateTime&gt;</span></span><br><span class="line"><span class="string">        &lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt;</span></span><br><span class="line"><span class="string">        &lt;Content&gt;&lt;![CDATA[&#123;Content&#125;]]&gt;&lt;/Content&gt;</span></span><br><span class="line"><span class="string">        &lt;/xml&gt;</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> XmlForm.format(**self.__dict)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageMsg</span><span class="params">(Msg)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, toUserName, fromUserName, mediaId)</span>:</span></span><br><span class="line">        self.__dict = dict()</span><br><span class="line">        self.__dict[<span class="string">'ToUserName'</span>] = toUserName</span><br><span class="line">        self.__dict[<span class="string">'FromUserName'</span>] = fromUserName</span><br><span class="line">        self.__dict[<span class="string">'CreateTime'</span>] = int(time.time())</span><br><span class="line">        self.__dict[<span class="string">'MediaId'</span>] = mediaId</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, toUserName, fromUserName,createTime,msgType, mediaId)</span>:</span></span><br><span class="line">        self.__dict = dict()</span><br><span class="line">        self.__dict[<span class="string">'ToUserName'</span>] = toUserName</span><br><span class="line">        self.__dict[<span class="string">'FromUserName'</span>] = fromUserName</span><br><span class="line">        self.__dict[<span class="string">'CreateTime'</span>] = createTime</span><br><span class="line">        self.__dict[<span class="string">'MsgType'</span>] = msgType</span><br><span class="line">        self.__dict[<span class="string">'MediaId'</span>] = mediaId</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self)</span>:</span></span><br><span class="line">        XmlForm = <span class="string">"""</span></span><br><span class="line"><span class="string">        &lt;xml&gt;</span></span><br><span class="line"><span class="string">        &lt;ToUserName&gt;&lt;![CDATA[&#123;ToUserName&#125;]]&gt;&lt;/ToUserName&gt;</span></span><br><span class="line"><span class="string">        &lt;FromUserName&gt;&lt;![CDATA[&#123;FromUserName&#125;]]&gt;&lt;/FromUserName&gt;</span></span><br><span class="line"><span class="string">        &lt;CreateTime&gt;&#123;CreateTime&#125;&lt;/CreateTime&gt;</span></span><br><span class="line"><span class="string">        &lt;MsgType&gt;&lt;![CDATA[image]]&gt;&lt;/MsgType&gt;</span></span><br><span class="line"><span class="string">        &lt;Image&gt;</span></span><br><span class="line"><span class="string">        &lt;MediaId&gt;&lt;![CDATA[&#123;MediaId&#125;]]&gt;&lt;/MediaId&gt;</span></span><br><span class="line"><span class="string">        &lt;/Image&gt;</span></span><br><span class="line"><span class="string">        &lt;/xml&gt;</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> XmlForm.format(**self.__dict)</span><br></pre></td></tr></table></figure><p></p><p>随机爬取表情包<br>getemoticon.py<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#导入模块</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> bs4</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建请求头列表，帮助我们在进行数据爬取的时候伪装成浏览器</span></span><br><span class="line">my_headers = [</span><br><span class="line">	<span class="string">"Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36"</span>,</span><br><span class="line">	<span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.153 Safari/537.36"</span>,</span><br><span class="line">	<span class="string">"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:30.0) Gecko/20100101 Firefox/30.0"</span>,</span><br><span class="line">	<span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.75.14 (KHTML, like Gecko) Version/7.0.3 Safari/537.75.14"</span>,</span><br><span class="line">	<span class="string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Win64; x64; Trident/6.0)"</span>,</span><br><span class="line">]</span><br><span class="line"> </span><br><span class="line">kv = &#123;<span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0"</span>&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getHTMLText</span><span class="params">(url, headers)</span>:</span></span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="comment">#随机从headers列表中选择一个header使用</span></span><br><span class="line">		random_header = random.choice(headers)</span><br><span class="line">		r = requests.get(url, headers=&#123;<span class="string">"User-Agent"</span>: random_header&#125;, timeout = <span class="number">30</span>)</span><br><span class="line">		<span class="comment">#校验是否爬取成功，如果获取失败，输出“爬取失败”</span></span><br><span class="line">		r.raise_for_status()</span><br><span class="line">		r.encoding = r.apparent_encoding</span><br><span class="line">		<span class="comment"># print r.text</span></span><br><span class="line">		<span class="keyword">return</span> r.text</span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		print(<span class="string">"爬取失败"</span>)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getImgList</span><span class="params">(Ilist, html)</span>:</span></span><br><span class="line">	<span class="comment">#使用python自带的html解析器，html.parser进行返回的html数据的解析工作</span></span><br><span class="line">	soup = BeautifulSoup(html, <span class="string">"html.parser"</span>)</span><br><span class="line">	<span class="comment"># print html</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">#分析解析后的html代码，通过正则表达式获取每一个图片对应的url地址，然后组成获取url的正则表达式</span></span><br><span class="line">	pattern_img = re.compile(<span class="string">r'data-original="(.+?)"'</span>)</span><br><span class="line">	<span class="comment">#获取图片对应的标题</span></span><br><span class="line">	pattern_title = re.compile(<span class="string">r'alt="(.+?)"'</span>)</span><br><span class="line">	<span class="comment">#找到所有的图片url值</span></span><br><span class="line">	imgList = re.findall(pattern_img, html)</span><br><span class="line">	<span class="comment"># print imgList</span></span><br><span class="line">	<span class="comment">#获取所有的图片对应的标题信息</span></span><br><span class="line">	titleList = re.findall(pattern_title, html)</span><br><span class="line">	<span class="comment"># print titleList[0].encode('utf-8')</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">#将每一对urli地址和title组成一个列表项，放入到另外一个列表项中可以通过下表进行调用</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(len(imgList)):</span><br><span class="line">		<span class="comment"># print i,</span></span><br><span class="line">		titleList[i] = titleList[i].encode(<span class="string">'utf-8'</span>)</span><br><span class="line">		<span class="comment"># print titleList[i]</span></span><br><span class="line">		Ilist.append([imgList[i], titleList[i]])</span><br><span class="line">	<span class="keyword">return</span> Ilist</span><br><span class="line"> </span><br><span class="line"><span class="comment">#判断是否存在指定的文件夹，然后创建文件夹</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mkdir</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'img'</span>):</span><br><span class="line">		os.mkdir(<span class="string">'img'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">saveImg</span><span class="params">(Ilistcontent)</span>:</span></span><br><span class="line">	mkdir()</span><br><span class="line">	img_content = requests.get(Ilistcontent[<span class="number">0</span>]).content</span><br><span class="line">	img_path=<span class="string">""</span></span><br><span class="line">	<span class="keyword">if</span> (Ilistcontent[<span class="number">0</span>][<span class="number">-4</span>:] == <span class="string">'.jpg'</span>):</span><br><span class="line">		img_path=<span class="string">'img/%s.jpg'</span> % (Ilistcontent[<span class="number">1</span>].decode(<span class="string">'utf-8'</span>))</span><br><span class="line">	<span class="keyword">elif</span> (Ilistcontent[<span class="number">0</span>][<span class="number">-4</span>:] == <span class="string">'.gif'</span>):</span><br><span class="line">		img_path=<span class="string">'img/%s.gif'</span> % (Ilistcontent[<span class="number">1</span>].decode(<span class="string">'utf-8'</span>))</span><br><span class="line">	<span class="keyword">if</span> os.path.exists(img_path):</span><br><span class="line">		<span class="keyword">return</span> img_path</span><br><span class="line">	<span class="keyword">with</span> open(img_path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">		f.write(img_content)</span><br><span class="line">		f.close()</span><br><span class="line">	<span class="keyword">return</span> img_path</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(page)</span>:</span></span><br><span class="line">	Ilist = []</span><br><span class="line">	url = <span class="string">"https://www.doutula.com/photo/list/?page=%d"</span> %page</span><br><span class="line">	html = getHTMLText(url, my_headers)</span><br><span class="line">	Ilist = getImgList(Ilist, html)</span><br><span class="line">	<span class="comment">#printImg(Ilist,page)</span></span><br><span class="line">	<span class="keyword">return</span> Ilist</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="comment">#page = 1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getRandomEmoticon</span><span class="params">()</span>:</span></span><br><span class="line">	print(<span class="string">"下载图片"</span>)</span><br><span class="line">	page= <span class="number">1</span>;</span><br><span class="line">	print(<span class="string">"第%d页"</span>%page)</span><br><span class="line">	Ilist= download(page);</span><br><span class="line">	i=random.randint(<span class="number">0</span>,len(Ilist)<span class="number">-1</span>)</span><br><span class="line">	print(<span class="string">"第%d张图"</span>%i)</span><br><span class="line">	path=saveImg(Ilist[i])</span><br><span class="line">	<span class="keyword">return</span> path</span><br></pre></td></tr></table></figure><p></p><p>这里我因为怕速度太慢只爬取了第一页，然后从第一页随机下载一个图片下来。逻辑应该还可以在优化，从本地直接上传表情包会更快。最好的方式应该是定期下载表情包，把表情存成永久素材，每次直接调用。但由于我是个懒癌晚期，完全不想进行后台管理，于是做成了随用随下载。</p><p>效果体验：<br><img src="/images/weixin.jpg" alt="微信公众号"></p></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div><button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'><span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/images/qrcode.jpg" alt="赵思佳 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"><img id="alipay_qr" src="/images/alipay.jpg" alt="赵思佳 支付宝"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Python/" rel="tag"># Python</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/01/07/RESTful-api架构设计/" rel="next" title="RESTful api架构设计"><i class="fa fa-chevron-left"></i> RESTful api架构设计</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2019/04/18/opencv特征检测/" rel="prev" title="opencv特征检测">opencv特征检测<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="赵思佳"><p class="site-author-name" itemprop="name">赵思佳</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">13</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">10</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">9</span> <span class="site-state-item-name">标签</span></a></div></nav></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前情提要"><span class="nav-number">1.</span> <span class="nav-text">前情提要</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">赵思佳</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.4"></script><script src="/js/src/motion.js?v=5.1.4"></script><script src="/js/src/scrollspy.js?v=5.1.4"></script><script src="/js/src/post-details.js?v=5.1.4"></script><script src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginModelPath:"assets/",model:{jsonPath:"/live2dw/assets/miku.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!1},log:!1,pluginJsPath:"lib/",pluginRootPath:"live2dw/",tagMode:!1})</script></body></html>